'use strict';

var sqlite3 = require('sqlite3'),
  config = require('./Config'),
  logger = config.log4js.getLogger('PushAssociations');

var db = new sqlite3.Database(config.get('sqlitePath'));
db.on('trace', function (query) {
  logger.trace(query);
});
db.run('CREATE TABLE IF NOT EXISTS push_associations (user TEXT NOT NULL, type TEXT NOT NULL, token TEXT NOT NULL, CONSTRAINT user_token UNIQUE (user, token))');

var add = function (user, deviceType, token, callback) {
  db.run('INSERT INTO push_associations VALUES (?, ?, ?)', user, deviceType, token, callback);
};

var updateTokens = function (fromToArray) {
  fromToArray.forEach(function (tokenUpdate) {
    db.run('UPDATE push_associations SET token = ? WHERE token = ?', tokenUpdate.to, tokenUpdate.from);
  });
};

var getAll = function (callback) {
  db.all('SELECT * FROM push_associations', callback);
};

var getForUser = function (user, callback) {
  db.all('SELECT * FROM push_associations WHERE user = ?', user, callback);
};

var getForUsers = function (users, callback) {
  // FIXME: prevent SQL injection (prepareStatement with "in (?,?)" doesn't work?!)
  var query = 'SELECT * FROM push_associations WHERE user in (';
  for (var i = 0; i < users.length; i++) {
    if (i > 0) query += ',';
    query += '\'' + users[i] + '\'';
  }
  query += ')';
  db.all(query, callback);
};

var removeForUser = function (user) {
  db.run('DELETE FROM push_associations WHERE user = ?', user);
};

var removeDevice = function (token) {
  db.run('DELETE FROM push_associations WHERE token = ?', token);
};

var removeDevices = function (tokens) {
  // FIXME: prevent SQL injection (prepareStatement with "in (?,?)" doesn't work?!)
  var query = 'DELETE FROM push_associations WHERE token in (';
  for (var i = 0; i < tokens.length; i++) {
    if (i > 0) query += ',';
    query += '\'' + tokens[i].toUpperCase() + '\'';
  }
  query += ')';
  db.run(query);
};

module.exports = {
  add: add,
  updateTokens: updateTokens,
  getAll: getAll,
  getForUser: getForUser,
  getForUsers: getForUsers,
  removeForUser: removeForUser,
  removeDevice: removeDevice,
  removeDevices: removeDevices
};